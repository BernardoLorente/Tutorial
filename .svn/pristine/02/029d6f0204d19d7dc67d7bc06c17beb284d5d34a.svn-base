<?php
class noticeModel extends model
{
    /**
     * Set menu.
     * 
     * @param  int    $dept 
     * @access public
     * @return void
     */
    public function setMenu($dept = 0)
    {
        common::setMenuVars($this->lang->notice->menu, 'name', array($this->app->company->name));
        common::setMenuVars($this->lang->notice->menu, 'addUser', array($dept));
        common::setMenuVars($this->lang->notice->menu, 'batchAddUser', array($dept));
    }

    /**
     * Get company list.
     * 
     * @access public
     * @return void
     */
    public function getList()
    {
        return $this->dao->select('*')->from(TABLE_COMPANY)->fetchAll();
    }

    /**
     * Get the first company.
     * 
     * @access public
     * @return void
     */
    public function getFirst()
    {
        return $this->dao->select('*')->from(TABLE_COMPANY)->orderBy('id')->limit(1)->fetch();
    }
    
    /**
     * Get company info by id.
     * 
     * @param  int    $companyID 
     * @access public
     * @return object
     */
    public function getByID($companyID = '')
    {
        return $this->dao->findById((int)$companyID)->from(TABLE_COMPANY)->fetch();
    }

    /**
     * Update a company.
     * 
     * @access public
     * @return void
     */
    public function update()
    {
        $company   = fixer::input('post')->stripTags('name')->get();        
        if($company->website  == 'http://') $company->website  = '';
        if($company->backyard == 'http://') $company->backyard = '';
        $companyID = $this->app->company->id;
        $this->dao->update(TABLE_COMPANY)
            ->data($company)
            ->autoCheck()
            ->batchCheck($this->config->company->edit->requiredFields, 'notempty')
            ->batchCheck('name', 'unique', "id != '$companyID'")
            ->where('id')->eq($companyID)
            ->exec();
    }

    /**
     * create a notice.
     * 
     * @access public
     * @return void
     */
    public function create()
    {
        $now = helper::now();
        $notice = fixer::input('post')
                    ->striptags('title')
                    ->remove('files,labels')
                    ->get();
        $notice->createtime = $now;
        $notice->creatorID = $this->session->user->account;

        $this->dao->insert(TABLE_NOTICE)->data($notice)
                //->autoCheck()
                //->batchCheck($this->config->notice->create->requiredFields, 'notempty')
                ->exec();

        if(!dao::isError())
        {   
            $noticeID = $this->dao->lastInsertID();
            $this->loadModel('file')->saveUpload('notice', $noticeID);
        }
        else
        {
            die(js::error(dao::getError()));
        }

        /*send mail to inform the receiver*/
        $this->loadModel('action')->create('notice', $noticeID, 'created');
    }

    /**
     * get notices.
     * 
     * @access public
     * @return void
     */
    public function getNotices($orderBy = 'createtime_desc', $pager = null)
    {
        switch ($this->session->userinfo->roleid) 
        {
            case 'student':
                return $this->dao->select('t1.*, t2.realname')
                            ->from(TABLE_NOTICE)->alias(t1)
                            ->leftJoin(TABLE_USER)->alias(t2)
                            ->on('t2.account=t1.creatorID')
                            ->where('t1.deleted')->eq(0)
                            ->andWhere('t2.college_id')->eq($this->session->userinfo->collegeid)
                            ->orWhere('t2.role_id')->eq('admin')
                            ->orderBy('t1.' . $orderBy)
                            ->page($pager)
                            ->fetchAll();
                break;
            
            case 'teacher':
                return $this->dao->select('t1.*, t2.realname')
                            ->from(TABLE_NOTICE)->alias(t1)
                            ->leftJoin(TABLE_USER)->alias(t2)
                            ->on('t2.account=t1.creatorID')
                            ->where('t1.deleted')->eq(0)
                            ->andWhere('t2.college_id')->eq($this->session->userinfo->collegeid)
                            ->orWhere('t2.role_id')->eq('admin')
                            ->andWhere('t2.role_id')->ne('teacher')
                            ->orderBy('t1.' . $orderBy)
                            ->page($pager)
                            ->fetchAll();
                break;

            case 'manager':
                return $this->dao->select('t1.*, t2.realname')
                            ->from(TABLE_NOTICE)->alias(t1)
                            ->leftJoin(TABLE_USER)->alias(t2)
                            ->on('t2.account=t1.creatorID')
                            ->where('t1.deleted')->eq(0)
                            ->andWhere('t2.college_id')->eq($this->session->userinfo->collegeid)
                            ->orWhere('t2.role_id')->eq('admin')
                            ->andWhere('t2.role_id')->in('manager,admin')
                            ->orderBy('t1.' . $orderBy)
                            ->page($pager)
                            ->fetchAll();
                break;

            case 'admin':
                return $this->dao->select('t1.*, t2.realname')
                            ->from(TABLE_NOTICE)->alias(t1)
                            ->leftJoin(TABLE_USER)->alias(t2)
                            ->on('t2.account=t1.creatorID')
                            ->where('t1.deleted')->eq(0)
                            ->andWhere('t2.college_id')->eq($this->session->userinfo->collegeid)
                            ->orWhere('t2.role_id')->eq('admin')
                            ->andWhere('t2.role_id')->eq('admin')
                            ->orderBy('t1.' . $orderBy)
                            ->page($pager)
                            ->fetchAll();
                break;
            default:
                return array();
                break;
        }
    }

    /**
     * get notice by ID.
     * 
     * @access public
     * @return void
     */
    public function getNoticeByID($noticeID)
    {
        $notice = $this->dao->select('*')
                            ->from(TABLE_NOTICE)
                            ->where('deleted')->eq(0)
                            ->andWhere('id')->eq($noticeID)
                            ->fetch();

        $notice->files = $this->loadModel('file')->getByObject('notice', $noticeID);

        return $notice;
    }

    /**
     * check the prive.
     * 
     * @access public
     * @return void
     */
    public function checkPriv($noticeID, $type = 'view')
    {
        $creator = $this->dao->select('t1.account, t1.role_id,t1.college_id')
                    ->from(TABLE_USER)->alias(t1)
                    ->leftJoin(TABLE_NOTICE)->alias(t2)
                    ->on('t1.account=t2.creatorID')
                    ->where('t2.id')->eq($noticeID)
                    ->fetch();

        if($creator->account == $this->session->user->account) return 1;
        if($type == 'delete') return 0;
        switch ($creator->role_id) 
        {
            case 'admin':
                return 1;
                break;
            
            case 'manager':
                if($this->session->userinfo->collegeid == $creator->college_id and 
                    ($this->session->userinfo->roleid == 'teacher' or $this->session->userinfo->roleid == 'student'))
                {
                    return 1;
                }
                return 0;
                break;

            case 'teacher':
                if($this->session->userinfo->collegeid == $creator->college_id and $this->session->userinfo->roleid == 'student')
                {
                    $students = $this->loadModel('student')->getStudents($creator->account);
                    foreach ($students as $student) 
                    {
                        if($student->account == $this->session->user->account)
                        {
                            return 1;
                        }
                    }
                }
                return 0;
                break;

            default:
                return 0;
                break;
        }
    }

    /**
     * delete the notice.
     * 
     * @access public
     * @return void
     */
    public function delete($noticeID)
    {
        // $oldnotice = $this->getById($noticeID);
        // $now     = helper::now();

        $notice = $this->getNoticeByID($noticeID);
        
        $this->dao->update(TABLE_NOTICE)
                ->set('deleted')->eq(1)
                ->where('id')->eq((int)$noticeID)->exec();
        $this->dao->update(TABLE_FILE)->set('deleted')->eq(1)->where('objectType')->eq('notice')->andWhere('objectID')->eq($noticeID)->andWhere('deleted')->eq(0)->exec();
        if (dao::isError())
        {
            die(js::error(dao::getError()));
        }
    }
}
